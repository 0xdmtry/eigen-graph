services:

  be-eigen-graph:
    container_name: be-eigen-graph
    build:
      context: ./be-eigen-graph
      dockerfile: Be.dev.dockerfile
    restart: always
    ports:
      - "8000:8000"
      - "8010:8010"
    volumes:
      - ./be-eigen-graph/src:/app/src
      - ./be-eigen-graph/migrations:/app/migrations
      - ./be-eigen-graph/Cargo.toml:/app/Cargo.toml
      - ./be-eigen-graph/Cargo.lock:/app/Cargo.lock
      - /app/target
    depends_on:
      db-eigen-graph:
        condition: service_healthy
      db-eigen-timescale:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://root:root@db-eigen-graph:5432/eigen-graph
      TIMESCALE_DATABASE_URL: postgres://root:root@db-eigen-timescale:5432/eigen-ts
    networks:
      - be-eigen-graph-net

  db-eigen-graph:
    container_name: db-eigen-graph
    image: postgres:17.4
    restart: always
    environment:
      POSTGRES_DB: eigen-graph
      POSTGRES_USER: root
      POSTGRES_PASSWORD: root
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U root -d eigen-graph" ]
      interval: 5s
      timeout: 3s
      retries: 10
    volumes:
      - .dbdata/postgres/dev/db-eigen-graph/:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - be-eigen-graph-net

  db-eigen-timescale:
    container_name: db-eigen-timescale
    image: timescale/timescaledb:latest-pg17
    restart: always
    environment:
      POSTGRES_DB: eigen-ts
      POSTGRES_USER: root
      POSTGRES_PASSWORD: root
      TIMESCALEDB_TELEMETRY: "off"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U root -d eigen-ts" ]
      interval: 5s
      timeout: 3s
      retries: 10
    volumes:
      - .dbdata/postgres/dev/db-eigen-timescale/:/var/lib/postgresql/data
    ports:
      - "5442:5432"
    networks:
      - be-eigen-graph-net


networks:
  be-eigen-graph-net:
    driver: bridge